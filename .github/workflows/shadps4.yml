name: Build Arti

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Clone the external repository
      - name: Clone arti repo
        run: git clone https://github.com/zydou/arti.git

      # Set up Rust (version >= 1.86)
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.87.0

      # Add ARM64 target
      - name: Add ARM64 target
        run: rustup target add aarch64-unknown-linux-gnu

      # Install cross compiler + OpenSSL for ARM64
      - name: Install cross compiler and OpenSSL
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            pkg-config \
            libssl-dev \
            libssl-dev:arm64

      # Verify Rust version
      - name: Check Rust version
        run: rustc --version

      # Build the project for ARM64
      - name: Build arti (ARM64)
        working-directory: arti
        env:
          OPENSSL_DIR: /usr/lib/aarch64-linux-gnu
          PKG_CONFIG_ALLOW_CROSS: 1
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig
        run: cargo build -p arti --locked --release --target aarch64-unknown-linux-gnu

      # Upload ARM64 build artifact
      - name: Upload arti ARM64 binary
        uses: actions/upload-artifact@v4
        with:
          name: arti-binary-arm64
          path: arti/target/aarch64-unknown-linux-gnu/release/arti
